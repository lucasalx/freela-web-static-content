import{r as d,j as e,a3 as Z,a4 as Q,y as Y,X as ee,a5 as u,a6 as te}from"./vendor-LjbCKWXj.js";import{u as se,a as re,A as h,b as ae}from"./index-DGoysZCb.js";import{M as oe}from"./Menu-BrhOyytM.js";import{V as ie,P as ne}from"./Vacancy-DmCJqM6Y.js";import{J as T}from"./Job-BUftFxvt.js";import"./monetaryUtil-Ccsb3nQ9.js";import"./useConfirmation-CMxKQYYz.js";import"./images-Cu8qV54H.js";import"./Loading-Cd5r56ie.js";import"./successAnimation-C1ByJTMN.js";function be(){const{authToken:c,chatBotToken:W,initialMessageSent:S,setInitialMessageSent:E,authUser:k,logout:P}=se(),{dispatch:f}=re(),w=d.useRef(!1),J=d.useRef(!1),A=d.useRef(!1),[i,R]=d.useState(null),[H,U]=d.useState(""),[N,x]=d.useState([]),[y,p]=d.useState({}),[g,j]=d.useState({}),[C,D]=d.useState(""),[L,O]=d.useState(!1),[m,I]=d.useState(null),q=()=>{O(!0)},F=()=>{O(!1)},_=async()=>{if(w.current=!0,c&&k){U(k.name.split(" ")[0]);const s=await ae.getProviderByUser(c);if(s){R(s);const t=new Uint8Array(s.profileImage.data).buffer,a=new Blob([t],{type:"image/jpeg"}),r=URL.createObjectURL(a);r&&D(r),W?S||(f({type:"SHOW_ALERT",payload:{type:"success",text:"Autenticação com chatbot concluída com sucesso"}}),E(!0)):S||(f({type:"SHOW_ALERT",payload:{type:"success",text:"Conectando pessoas à oportunidades"}}),E(!0))}}},$=async()=>{if(c&&i){const s=await h.request({origin:"Web",method:"GET",url:`/providers/${i.id}/active-jobs`,authToken:c});if(s.success&&s.data){const t=s.data;if(t.length>0){const a=t.reduce((r,o)=>{const n=o.vacancyId;return r[n]||(r[n]=[]),r[n].push(o),r},{});j(a)}else j({})}else j({})}},B=async()=>{if(c&&i){const s=await h.request({origin:"Web",method:"GET",url:`/providers/${i.id}/future-jobs`,authToken:c});if(s.success&&s.data){const t=s.data;if(t.length>0){const a=t.reduce((r,o)=>{const n=o.vacancyId;return r[n]||(r[n]=[]),r[n].push(o),r},{});p(a)}else p({})}else p({})}},V=async()=>{if(c&&i){const s=await h.request({origin:"Web",method:"GET",url:`/providers/${i.id}/applied-vacancies`,authToken:c});if(s.success&&s.data){const t=s.data;t.length>0?x(t):x([])}else x([])}},K=async s=>{s&&f({type:"SHOW_ALERT",payload:{type:"success",text:"Serviço iniciado com sucesso"}})},M=async s=>{if(s&&c){const t=await h.request({origin:"Web",method:"DELETE",url:`/jobs/${s}`,authToken:c});if(t.success&&t.data)f({type:"SHOW_ALERT",payload:{type:"success",text:"Serviço cancelado e desmarcado com sucesso"}});else{let a;t.statusCode!==404?a="Houve um erro inesperado ao cancelar e desmarcar o serviço":a="Houve um erro ao cancelar e desmarcar o serviço",f({type:"SHOW_ALERT",payload:{type:"error",text:a}})}}},G=async s=>{if(s&&c){const t=await h.request({origin:"Web",method:"PATCH",url:`/jobs/${s}/terminate`,authToken:c});if(t.success&&t.data)f({type:"SHOW_ALERT",payload:{type:"info",text:"Obrigado por usar o FreeLa"}});else{let a;t.statusCode!==404?a="Houve um erro inesperado ao encerrar o serviço":a="Houve um erro ao encerrar o serviço",f({type:"SHOW_ALERT",payload:{type:"error",text:a}})}}},z=async(s,t)=>{if(c){const a=t.getKey("auth"),r=t.getKey("p256dh");if(a&&r){const o={endpoint:t.endpoint,keys:{auth:btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(a)))),p256dh:btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(r))))},createdAt:new Date,userId:s},n=await h.request({origin:"Web",method:"POST",url:"/users/notification-subscriptions",data:o,authToken:c});if(n.success&&n.data)return!0;{let l;return n.statusCode!==404?l="Houve um erro inesperado ao salvar a assinatura de notificação de usuário":l="Houve um erro ao salvar a assinatura de notificação de usuário",f({type:"SHOW_ALERT",payload:{type:"error",text:l}}),!1}}else console.error("Authentication keys not found")}return!1},X=()=>{const s=te("https://freela-servicos.duckdns.org");I(s),s.on("contractorDeletedVacancy",t=>{x(a=>a.filter(r=>r.id!==t))}),s.on("contractorAcceptedCandidacy",t=>{i.id===t.providerId&&t.vacancy.status==="in hiring"&&x(a=>{const r=a.findIndex(o=>o.id===t.vacancy.id);if(r!==-1){const o=[...a];return o[r]={...o[r],...t.vacancy},o}return[t.vacancy,...a]})}),s.on("contractorRejectedCandidacy",async t=>{i.id===t.providerId&&x(a=>a.filter(r=>r.id!==t.vacancyId))}),s.on("contractorScheduledJob",async t=>{if(!(y[t]!==void 0)&&c){const r=await h.request({origin:"Web",method:"GET",url:`/providers/${i.id}/future-jobs`,authToken:c});if(r.success&&r.data){const o=r.data;if(o.length>0){const n=o.reduce((l,v)=>{const b=v.vacancyId;return l[b]||(l[b]=[]),l[b].push(v),l},{});p(n)}else p({})}else p({})}}),s.on("contractorCanceledJob",t=>{y[t]!==void 0&&p(r=>Object.keys(r).reduce((n,l)=>{const v=r[l].filter(b=>b.vacancyId!==t);return n[l]=v,n},{}))}),s.on("providerCreatedCandidacy",async t=>{if(i.id===t.providerId&&c){const a=await h.request({origin:"Web",method:"GET",url:`/vacancies/${t.vacancyId}`,authToken:c});if(a.success&&a.data){const r=a.data;x(o=>o.some(l=>l.id===r.id)?o:[r,...o])}}}),s.on("providerDeletedCandidacy",({candidacyId:t,vacancy:a})=>{t&&x(r=>r.filter(o=>o.id!==a.id))}),s.on("providerCanceledJob",({jobId:t,vacancy:a})=>{p(r=>{const o=a.id;if(!r[o])return r;const n=r[o].filter(l=>l.id!==t);return n.length===r[o].length?r:{...r,[o]:n}})}),s.on("providerTerminatedJob",t=>{y[t]!==void 0&&j(r=>Object.keys(r).reduce((n,l)=>{const v=r[l].filter(b=>b.vacancyId!==t);return n[l]=v,n},{}))});//!Posteriormente implementar verificação para passar um future job para active job
};return d.useEffect(()=>{if(!(!i||A.current))return A.current=!0,"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(async s=>{if(console.log("Service Worker pronto, scope: ",s.scope),await Notification.requestPermission()!=="granted"){console.warn("Notificações negadas pelo usuário");return}const a=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:"BDaAHff3qEShIRpC0_hm-uDDX3UzXzpZ7tl39isONVcxoi8lNXFpM4lieOUJOOAlI9_VUEi2Hhh4ZW2syKpTL4Q"});await z(i.userId,a)}).catch(s=>{console.error("Erro no processo de inscrição de notificações: ",s)}),X(),()=>{m&&m.connected&&(m.off("contractorDeletedVacancy"),m.off("contractorAcceptedCandidacy"),m.off("contractorRejectedCandidacy"),m.off("contractorScheduledJob"),m.off("contractorCanceledJob"),m.off("providerCreatedCandidacy"),m.off("providerDeletedCandidacy"),m.off("providerCanceledJob"),m.off("providerTerminatedJob"),m.disconnect())}},[i]),d.useEffect(()=>{if(c&&i){if(J.current)return;(async()=>{J.current=!0,await Promise.all([$(),B(),V()])})()}},[i,c]),d.useEffect(()=>{w.current||(async()=>(await _(),w.current=!0))()},[]),e.jsxs(e.Fragment,{children:[i?e.jsx("div",{className:"w-full min-h-screen py-32 bg-secondaryColor desktop:px-96 laptop:px-44 tablet:px-20 mobile:px-2 mobile:pt-10 tablet:pb-32 mobile:pb-28",children:e.jsxs("div",{className:"flex flex-row justify-start mobile:flex-col mobile:justify-center",children:[e.jsxs("div",{className:"flex items-end justify-between",children:[e.jsxs("div",{className:"flex flex-row",children:[e.jsx("div",{className:"flex items-center justify-center rounded-full w-52 mobile:w-28 mobile:h-28 h-52 bg-quinaryColor",children:C&&C!==""?e.jsx("img",{src:C,alt:"Imagem de perfil do Freelancer",className:"w-full h-full rounded-full"}):e.jsx(Z,{className:"text-tertiaryColor",size:80})}),e.jsxs("div",{className:"flex flex-col justify-end ml-14 mobile:ml-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-3xl font-semibold text-tertiaryColor font mobile:text-2xl",children:"Olá"}),e.jsx("span",{className:"text-4xl font-semibold text-primaryColor font mobile:text-3xl",children:H})]}),e.jsx("div",{className:"mt-1",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{children:e.jsx(Q,{readOnly:!0,value:i.feedbackStars,emptyIcon:e.jsx(Y,{className:"text-quinaryColor",size:24})})}),e.jsx("div",{children:i.feedbackStars>0?e.jsx("button",{className:`text-sm font-semibold ${L?"text-primaryColor":"text-tertiaryColor"} hover:text-primaryColor`,onClick:q,children:"Ver avaliações"}):e.jsx("span",{className:"text-sm font-semibold text-tertiaryColor",children:"(Nenhuma avaliação)"})})]})})]})]}),e.jsx("button",{className:"text-lg font-semibold text-tertiaryColor hover:text-primaryColor",onClick:()=>P(),children:"Sair"})]}),e.jsxs("div",{className:"mt-10",children:[e.jsx("div",{className:"flex flex-row",children:e.jsx("span",{className:"text-lg font-semibold underline text-tertiaryColor underline-offset-8",children:"Serviços ativos"})}),g&&Object.keys(g).length>0?Object.keys(g).map(s=>e.jsx(T,{jobs:g[s],profileType:"provider",provider:i,onStart:async t=>{await K(t)},onTerminate:async t=>{t&&await G(t)}},s)):e.jsx("div",{className:"flex items-center justify-center w-full h-10",children:e.jsx("span",{className:"mt-2 text-tertiaryColor text-start",children:"Nenhum serviço ativo encontrado"})})]}),e.jsx("div",{className:"flex flex-row items-center justify-start w-full mt-5 text-primaryColor",children:e.jsx("hr",{className:"w-[45%]"})}),e.jsxs("div",{className:"mt-10",children:[e.jsx("span",{className:"text-lg font-semibold underline text-tertiaryColor underline-offset-8",children:"Serviços futuros"}),y&&Object.keys(y).length>0?Object.keys(y).map(s=>e.jsx(T,{jobs:y[s],profileType:"provider",provider:i,onCancel:async t=>{t&&await M(t)}},s)):e.jsx("div",{className:"flex items-center justify-center w-full h-10",children:e.jsx("span",{className:"mt-2 text-tertiaryColor text-start",children:"Nenhum serviço futuro encontrado"})})]}),e.jsx("div",{className:"flex flex-row items-center justify-start w-full mt-5 text-primaryColor",children:e.jsx("hr",{className:"w-[45%]"})}),e.jsxs("div",{className:"mt-10",children:[e.jsx("div",{className:"flex flex-row",children:e.jsx("span",{className:"text-lg font-semibold underline text-tertiaryColor underline-offset-8",children:"Vagas preenchidas"})}),N&&N.length>0?N.map(s=>e.jsx(ie,{vacancy:s,provider:i,profileType:"provider"},s.id)):e.jsx("div",{className:"flex items-center justify-center w-full h-10",children:e.jsx("span",{className:"mt-2 text-tertiaryColor text-start",children:"Nenhuma vaga preenchida encontrada"})})]}),e.jsx("div",{className:"flex flex-row items-center justify-start w-full mt-5 text-primaryColor",children:e.jsx("hr",{className:"w-[45%]"})})]})}):e.jsx("div",{className:"w-full h-screen desktop:px-80 laptop:px-36 tablet:px-24 mobile:px-2 mobile:pt-2 mobile:pb-32 bg-secondaryColor",children:e.jsxs(ee,{children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"1rem",className:"mx-auto mt-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"8.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"16rem",className:"rounded-md"}),e.jsxs("div",{className:"flex justify-start w-full h-24 laptop:flex-row mobile:flex-col",children:[e.jsxs("div",{className:"flex flex-row desktop:w-[50%] laptop:w-[60%] tablet:w-[60%] mobile:w-full laptop:justify-start mobile:justify-between",children:[e.jsxs("div",{className:"flex flex-col w-[17rem]",children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"})]}),e.jsx("div",{className:"flex items-end justify-center w-10 h-full",children:e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"55%",height:"0.2rem",className:"mb-6 rounded-md"})}),e.jsxs("div",{className:"flex flex-col w-[7.5rem]",children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"})]})]}),e.jsxs("div",{className:"flex flex-col w-full laptop:ml-10",children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"})]})]})]})}),e.jsx(oe,{profileType:"provider",pageSelected:"home"}),i&&e.jsx(ne,{providerId:i.id,open:L,onClose:F})]})}export{be as ProviderHome};
