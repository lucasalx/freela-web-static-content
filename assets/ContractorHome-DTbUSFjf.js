import{r as d,j as e,a3 as Y,a4 as ee,y as te,X as se,a5 as u,a6 as re}from"./vendor-LjbCKWXj.js";import{u as oe,a as ae,A as y,b as ie}from"./index-BpyeDjJi.js";import{V as ne,C as ce}from"./Vacancy-CZPfbHa-.js";import{M as le}from"./Menu-BQTnasxO.js";import{J as W}from"./Job-Bg3sXxCL.js";import{L as de}from"./Loading-Cd5r56ie.js";import"./monetaryUtil-Ccsb3nQ9.js";import"./useConfirmation-EKFoT3NN.js";import"./images-Bf77nNy9.js";import"./successAnimation-C1ByJTMN.js";function ve(){const{authToken:c,chatBotToken:R,authUser:C,initialMessageSent:S,setInitialMessageSent:E,logout:H}=oe(),{dispatch:f}=ae(),L=d.useRef(!1),k=d.useRef(!1),J=d.useRef(!1),[n,U]=d.useState(null),[D,I]=d.useState(""),[w,q]=d.useState(""),[N,x]=d.useState([]),[p,h]=d.useState({}),[j,v]=d.useState({}),[A,O]=d.useState(!1),[F,_]=d.useState(!1),[m,$]=d.useState(null),P=()=>{O(!0)},K=()=>{O(!1)},M=async()=>{if(c&&C){I(C.name.split(" ")[0]);const s=await ie.getContractorByUser(c);if(s){U(s),_(!1);const t=new Uint8Array(s.profileImage.data).buffer,o=new Blob([t],{type:"image/jpeg"}),r=URL.createObjectURL(o);r&&q(r),R?S||(f({type:"SHOW_ALERT",payload:{type:"success",text:"Autenticação com chatbot concluída com sucesso"}}),E(!0)):S||(f({type:"SHOW_ALERT",payload:{type:"success",text:"Conectando pessoas à oportunidades"}}),E(!0))}}},T=async()=>{if(c&&n){const s=await y.request({origin:"Web",method:"GET",url:`/contractors/${n.id}/active-jobs`,authToken:c});if(s.success&&s.data){const t=s.data;if(t.length>0){const o=t.reduce((r,a)=>{const i=a.vacancyId;return r[i]||(r[i]=[]),r[i].push(a),r},{});v(o)}else v({})}else v({})}},V=async()=>{if(c&&n){const s=await y.request({origin:"Web",method:"GET",url:`/contractors/${n.id}/future-jobs`,authToken:c});if(s.success&&s.data){const t=s.data;if(t.length>0){const o=t.reduce((r,a)=>{const i=a.vacancyId;return r[i]||(r[i]=[]),r[i].push(a),r},{});h(o)}else h({})}else h({})}},z=async()=>{if(c&&n){const s=await y.request({origin:"Web",method:"GET",url:`/contractors/${n.id}/vacancies`,authToken:c});if(s.success&&s.data){const t=s.data;t.length>0?x(t):x([])}else x([])}},B=async s=>{if(c){const t=await y.request({origin:"Web",method:"DELETE",url:`/vacancies/${s}`,authToken:c});if(t.success&&t.data)f({type:"SHOW_ALERT",payload:{type:"success",text:"Vaga removida com sucesso"}});else{let o;t.statusCode!==404?o="Houve um erro inesperado ao remover a vaga":o="Houve um erro ao remover a vaga",f({type:"SHOW_ALERT",payload:{type:"error",text:o}})}}},G=async s=>{if(c){const t=await y.request({origin:"Web",method:"DELETE",url:`/vacancies/${s}/jobs`,authToken:c});if(t.success&&t.data)f({type:"SHOW_ALERT",payload:{type:"success",text:"Serviço cancelado e desmarcado com sucesso"}});else{let o;t.statusCode!==404?o="Houve um erro inesperado ao cancelar e desmarcar o serviço":o="Houve um erro ao cancelar e desmarcar o serviço",f({type:"SHOW_ALERT",payload:{type:"error",text:o}})}}},X=async s=>{s&&(f({type:"SHOW_ALERT",payload:{type:"info",text:"Obrigado por usar o FreeLa"}}),await T())},Z=async(s,t)=>{if(c){const o=t.getKey("auth"),r=t.getKey("p256dh");if(o&&r){const a={endpoint:t.endpoint,keys:{auth:btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(o)))),p256dh:btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(r))))},createdAt:new Date,userId:s},i=await y.request({origin:"Web",method:"POST",url:"/users/notification-subscriptions",data:a,authToken:c});if(i.success&&i.data)return!0;{let l;return i.statusCode!==404?l="Houve um erro inesperado ao salvar a assinatura de notificação de usuário":l="Houve um erro ao salvar a assinatura de notificação de usuário",f({type:"SHOW_ALERT",payload:{type:"error",text:l}}),!1}}else console.error("Authentication keys not found")}return!1},Q=()=>{const s=re("https://freela-servicos.duckdns.org");$(s),s.on("contractorCreatedVacancy",t=>{n.id===t.contractorId&&x(o=>o.some(a=>a.id===t.id)?o:[t,...o])}),s.on("contractorDeletedVacancy",t=>{x(o=>o.some(a=>a.id===t)?o.filter(a=>a.id!==t):o)}),s.on("contractorAcceptedCandidacy",t=>{n.id===t.vacancy.contractorId&&t.vacancy.status==="in hiring"&&x(o=>{const r=o.findIndex(a=>a.id===t.vacancy.id);if(r!==-1){const a=[...o];return a[r]={...a[r],...t.vacancy},a}return[t.vacancy,...o]})}),s.on("contractorScheduledJob",async t=>{if(x(r=>r.some(i=>i.id===t)?r.filter(i=>i.id!==t):r),!(p[t]!==void 0)&&c){const r=await y.request({origin:"Web",method:"GET",url:`/contractors/${n.id}/future-jobs`,authToken:c});if(r.success&&r.data){const a=r.data;if(a.length>0){const i=a.reduce((l,g)=>{const b=g.vacancyId;return l[b]||(l[b]=[]),l[b].push(g),l},{});h(i)}else h({})}else h({})}}),s.on("contractorCanceledJob",t=>{p[t]!==void 0&&h(r=>Object.keys(r).reduce((i,l)=>{const g=r[l].filter(b=>b.vacancyId!==t);return i[l]=g,i},{}))}),s.on("contractorTerminatedJob",t=>{p[t]!==void 0&&v(r=>Object.keys(r).reduce((i,l)=>{const g=r[l].filter(b=>b.vacancyId!==t);return i[l]=g,i},{}))}),s.on("providerDeletedCandidacy",({candidacyId:t,vacancy:o})=>{n.id===o.contractorId&&t&&o.status!=="in hiring"&&x(r=>{const a=r.findIndex(i=>i.id===o.id);if(a!==-1){const i=[...r];return i[a]={...i[a],...o},i}return[o,...r]})}),s.on("providerCanceledJob",({jobId:t,vacancy:o})=>{h(r=>{const a=o.id;if(!r[a])return r;const i=r[a].filter(l=>l.id!==t);return i.length===r[a].length?r:{...r,[a]:i}})});//!Posteriormente implementar verificação para passar um future job para active job
};return d.useEffect(()=>{if(!(!n||J.current))return J.current=!0,"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(async s=>{if(console.log("Service Worker pronto, scope: ",s.scope),await Notification.requestPermission()!=="granted"){console.warn("Notificações negadas pelo usuário");return}const o=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:"BDaAHff3qEShIRpC0_hm-uDDX3UzXzpZ7tl39isONVcxoi8lNXFpM4lieOUJOOAlI9_VUEi2Hhh4ZW2syKpTL4Q"});await Z(n.userId,o)}).catch(s=>{console.error("Erro no processo de inscrição de notificações: ",s)}),Q(),()=>{m&&m.connected&&(m.off("contractorCreatedVacancy"),m.off("contractorDeletedVacancy"),m.off("contractorAcceptedCandidacy"),m.off("contractorScheduledJob"),m.off("contractorCanceledJob"),m.off("contractorTerminatedJob"),m.off("providerDeletedCandidacy"),m.off("providerCanceledJob"),m.disconnect())}},[n]),d.useEffect(()=>{if(c&&n){if(k.current)return;(async()=>{k.current=!0,await Promise.all([T(),V(),z()])})()}},[n,c]),d.useEffect(()=>{L.current||(async()=>(await M(),L.current=!0))()},[]),e.jsxs(e.Fragment,{children:[n?e.jsx("div",{className:"w-full min-h-screen py-32 bg-secondaryColor desktop:px-96 laptop:px-44 tablet:px-20 mobile:px-2 mobile:pt-10 tablet:pb-32 mobile:pb-28",children:e.jsxs("div",{className:"flex flex-row justify-start mobile:flex-col mobile:justify-center",children:[e.jsxs("div",{className:"flex items-end justify-between",children:[e.jsxs("div",{className:"flex flex-row",children:[e.jsx("div",{className:"flex items-center justify-center rounded-full w-52 mobile:w-28 mobile:h-28 h-52 bg-quinaryColor",children:w&&w!==""?e.jsx("img",{src:w,alt:`Imagem de perfil de ${n.corporateReason}`,className:"w-full h-full rounded-full"}):e.jsx(Y,{className:"text-tertiaryColor",size:80})}),e.jsxs("div",{className:"flex flex-col justify-end ml-14 mobile:ml-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-3xl font-semibold text-tertiaryColor font mobile:text-2xl",children:"Olá"}),e.jsx("span",{className:"text-4xl font-semibold text-primaryColor font mobile:text-3xl",children:D})]}),e.jsx("div",{className:"mt-1",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{children:e.jsx(ee,{readOnly:!0,value:n.feedbackStars,emptyIcon:e.jsx(te,{className:"text-quinaryColor",size:24})})}),e.jsx("div",{children:n.feedbackStars>0?e.jsx("button",{className:`text-sm font-semibold ${A?"text-primaryColor":"text-tertiaryColor"} hover:text-primaryColor`,onClick:P,children:"Ver avaliações"}):e.jsx("span",{className:"text-sm font-semibold text-tertiaryColor",children:"(Nenhuma avaliação)"})})]})})]})]}),e.jsx("button",{className:"text-lg font-semibold text-tertiaryColor hover:text-primaryColor",onClick:()=>H(),children:"Sair"})]}),e.jsxs("div",{className:"mt-10",children:[e.jsx("div",{className:"flex flex-row",children:e.jsx("span",{className:"text-lg font-semibold underline text-tertiaryColor underline-offset-8",children:"Serviços ativos"})}),j&&Object.keys(j).length>0?Object.keys(j).map(s=>e.jsx(W,{jobs:j[s],profileType:"contractor",onTerminate:async t=>{t||await X(s)}},s)):e.jsx("div",{className:"flex items-center justify-center w-full h-10",children:e.jsx("span",{className:"mt-2 text-tertiaryColor text-start",children:"Nenhum serviço ativo encontrado"})})]}),e.jsx("div",{className:"flex flex-row items-center justify-start w-full mt-5 text-primaryColor",children:e.jsx("hr",{className:"w-[45%]"})}),e.jsxs("div",{className:"mt-10",children:[e.jsx("span",{className:"text-lg font-semibold underline text-tertiaryColor underline-offset-8",children:"Serviços futuros"}),p&&Object.keys(p).length>0?Object.keys(p).map(s=>e.jsx(W,{jobs:p[s],profileType:"contractor",onCancel:async t=>{t||await G(s)}},s)):e.jsx("div",{className:"flex items-center justify-center w-full h-10",children:e.jsx("span",{className:"mt-2 text-tertiaryColor text-start",children:"Nenhum serviço futuro encontrado"})})]}),e.jsx("div",{className:"flex flex-row items-center justify-start w-full mt-5 text-primaryColor",children:e.jsx("hr",{className:"w-[45%]"})}),e.jsxs("div",{className:"mt-10",children:[e.jsx("div",{className:"flex flex-row",children:e.jsx("span",{className:"text-lg font-semibold underline text-tertiaryColor underline-offset-8",children:"Vagas criadas em aberto"})}),N&&N.length>0?N.map(s=>e.jsx(ne,{vacancy:s,profileType:"contractor",onRemoved:async()=>{await B(s.id)}},s.id)):e.jsx("div",{className:"flex items-center justify-center w-full h-10",children:e.jsx("span",{className:"mt-2 text-tertiaryColor text-start",children:"Nenhuma vaga em aberto encontrada"})})]}),e.jsx("div",{className:"flex flex-row items-center justify-start w-full mt-5 text-primaryColor",children:e.jsx("hr",{className:"w-[45%]"})})]})}):e.jsx("div",{className:"w-full h-screen desktop:px-80 laptop:px-36 tablet:px-24 mobile:px-2 mobile:pt-2 mobile:pb-32 bg-secondaryColor",children:e.jsxs(se,{children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"1rem",className:"mx-auto mt-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"8.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"16rem",className:"rounded-md"}),e.jsxs("div",{className:"flex justify-start w-full h-24 laptop:flex-row mobile:flex-col",children:[e.jsxs("div",{className:"flex flex-row desktop:w-[50%] laptop:w-[60%] tablet:w-[60%] mobile:w-full laptop:justify-start mobile:justify-between",children:[e.jsxs("div",{className:"flex flex-col w-[17rem]",children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"})]}),e.jsx("div",{className:"flex items-end justify-center w-10 h-full",children:e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"55%",height:"0.2rem",className:"mb-6 rounded-md"})}),e.jsxs("div",{className:"flex flex-col w-[7.5rem]",children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"})]})]}),e.jsxs("div",{className:"flex flex-col w-full laptop:ml-10",children:[e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"7.5rem",height:"0.6rem",className:"mt-[1.75rem] mb-2 rounded-md"}),e.jsx(u,{sx:{bgcolor:"grey.900"},variant:"rectangular",width:"100%",height:"3rem",className:"rounded-md"})]})]})]})}),e.jsx(le,{profileType:"contractor",pageSelected:"home"}),n&&e.jsx(ce,{contractorId:n.id,open:A,onClose:K}),F&&e.jsx(de,{})]})}export{ve as ContractorHome};
